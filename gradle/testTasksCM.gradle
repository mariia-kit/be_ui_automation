class TestCM extends Test {
    TestCM() {
        group "cm tests"

        ignoreFailures = false

        minHeapSize = '32m'
        maxHeapSize = '256m'
        maxParallelForks = Runtime.runtime.availableProcessors().intdiv(2) ?: 1
        forkEvery = 8

        useJUnitPlatform() {
            excludeTags "neutral_server", "e2e", "smoke_cm", "ui", "userAccount"
        }

        systemProperties = [
                "stg.access.key.id"                                        : System.getenv("ACCESS_KEY_ID_STG"),
                "stg.access.key.secret"                                    : System.getenv("ACCESS_KEY_SECRET_STG"),
                "prod.access.key.id"                                       : System.getenv("ACCESS_KEY_ID_PROD"),
                "prod.access.key.secret"                                   : System.getenv("ACCESS_KEY_SECRET_PROD"),
                'junit.jupiter.execution.parallel.enabled'                 : true,
                'junit.jupiter.execution.parallel.mode.default'            : 'same_thread',
                'junit.jupiter.execution.parallel.mode.classes.default'    : 'concurrent',
                'junit.jupiter.execution.parallel.config.strategy'         : 'fixed',
                'junit.jupiter.execution.parallel.config.fixed.parallelism': 8
        ]

        def dynamicEnvUrl = System.getenv("DYNAMIC_ENV_URL")
        if (!dynamicEnvUrl) finalizedBy "allureAggregatedReportCM"
    }
}

ext {
    jira_login = "svc-ns-bot"
    jira_pass = "HtSUxXwdb2aoVfkLfvAoMbPV"
}

def targetEnv = System.getenv("CI_ENVIRONMENT_SLUG")
def dynamicEnvUrl = System.getenv("DYNAMIC_ENV_URL")
def finalEnv = "dev"
if (targetEnv != null && !targetEnv.isEmpty()) {
    finalEnv = targetEnv
    println "Receive env from CI_ENVIRONMENT_SLUG ${targetEnv}"
} else {
    finalEnv = hasProperty('env') ? env : 'dev'
    println "Receive env from property ${finalEnv}"
}

println "Run script for CM env >>>>> ${finalEnv}"

task initTokens(type: JavaExec) {
    logging.captureStandardOutput(LogLevel.QUIET)

    systemProperty "env", finalEnv
    classpath sourceSets.main.runtimeClasspath
    main = "com.here.platform.common.DataPreparation"
}

task smokeCMTests(type: TestCM) {
    failFast true
    //todo add execution for all tests except Sentry checkers

    if (!dynamicEnvUrl) {
        systemProperty "env", finalEnv
    } else {
        println "Will be used dynamic url: $finalEnv"
        systemProperty "dynamicUrl", dynamicEnvUrl
        systemProperty "env", "dev"
    }
    useJUnitPlatform {
        includeTags "smoke_cm"
    }
    if (!dynamicEnvUrl) finalizedBy "initTokens"
}

task userAccount(type: TestCM) {
    maxParallelForks = 1
    forkEvery = 0

    systemProperty "env", finalEnv
    useJUnitPlatform {
        includeTags "userAccount"
        excludeTags "ui"
    }
}

task uiTests(type: TestCM, dependsOn: "initTokens") {
    maxParallelForks = 1
    forkEvery = 0

    systemProperty "env", finalEnv
    useJUnitPlatform {
        includeTags "ui"
    }
}

task devTests(type: TestCM, dependsOn: "smokeCMTests") {
    systemProperty "env", "dev"

    finalizedBy "userAccount", "uiTests"
}

task sitTests(type: TestCM, dependsOn: "smokeCMTests") {
    systemProperty "env", "sit"
    systemProperty "jira_sync", "true"

    finalizedBy "userAccount", "uiTests"
}

task prodTests(type: TestCM, dependsOn: "smokeCMTests") {
    group "cm tests"

    systemProperty "env", "prod"
    systemProperty "jira_sync", "true"

    finalizedBy "userAccount", "uiTests"
}

task zephyrCMSync(type: JavaExec) {
    main = "lv.ctco.zephyr.Runner"
    description = "Run Sync test results into Zephyr test cycle"
    classpath sourceSets.main.runtimeClasspath

    def serviceName = System.getProperty('SERVICE') ?: 'null'
    def serviceVersion = System.getProperty('IMAGE_TAG') ?: 'null'

    def cycleValue = "$serviceName:$serviceVersion"

    if (cycleValue == "null:null") {
        cycleValue = "CM:latest"
    }

    def resultsPath = System.getProperty("results_path")

    println "Current user and service: $jira_login $cycleValue"
    args = [
            "--username=${jira_login}", "--password=${jira_pass}",
            "--reportType=allure", "--projectKey=NS",
            "--releaseVersion=Neutral Server v.0.4",
            "--testCycle=${cycleValue}",
            "--jiraUrl=https://saeljira.it.here.com/rest/",
            "--reportPath=$resultsPath",
            "--autoCreateTestCycle=true"
    ]
}

task allureAggregatedReportCM {
    doFirst {
        copy {
            description 'Copies the old history directory to the current test run data.'
            println "Copy global history to ${allure.resultsDir.absolutePath}/history"
            mkdir "${allure.resultsDir.absolutePath}/history"
            from "$rootDir/history_cm"
            into "${allure.resultsDir.absolutePath}/history"
        }
    }
    doLast {
        copy {
            description 'Copies the new CM history directory to folder to store.'
            println "Copy local history to $rootDir/history_cm"
            from "${allure.reportDir.absolutePath}/history"
            into "$rootDir/history_cm"
        }
    }
    finalizedBy 'allureReport'
}
